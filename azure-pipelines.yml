pool: julienh

variables:
  - group: sonarsource-build-variables

resources:
  repositories:
    - repository: commonTemplates
      type: git
      name: pipelines-yaml-templates
      ref:  refs/tags/v1.0.9


stages:
- template: stage-with-burgr-notifications.yml@commonTemplates
  parameters:
    burgrName: 'build'
    burgrType: 'build'
    stageName: 'build'
    stageDisplayName: Build and stage to repox
    jobs:
    - job: build
      displayName: Build and stage to repox
      variables:
        GRADLE_USER_HOME: $(Pipeline.Workspace)/.gradle
        fixedBranch: $[replace(variables['Build.SourceBranch'], 'refs/heads/', '')]
      steps:
      - checkout: self
        fetchDepth: 1
      - template: update-gradle-version-steps.yml
      - task: Gradle@2
        inputs:
          options: --stacktrace -i
          tasks: buildPlugin artifactoryPublish
          publishJUnitResults: false
          jdkVersionOption: '1.11'
        env:
          ARTIFACTORY_DEPLOY_USERNAME: $(ARTIFACTORY_DEPLOY_USERNAME)
          ARTIFACTORY_DEPLOY_PASSWORD: $(ARTIFACTORY_DEPLOY_PASSWORD)
          GIT_SHA1: $(Build.SourceVersion)
          GITHUB_BRANCH: $(fixedBranch)
        displayName: 'Run Gradle build and deploy'
- template: stage-with-burgr-notifications.yml@commonTemplates
  parameters:
    burgrName: 'qa'
    burgrType: 'qa'
    stageName: 'qa'
    stageDisplayName: Run ITs
    stageDependencies: build
    jobs:
    - job: its
      displayName: Run ITs
      strategy:
        matrix:
#          Idea2018:
#            IDEA_VERSION: 'IC-2018.3'
#            JDKVersion: '1.11'
#          Idea2019:
#            IDEA_VERSION: 'IC-2019.3'
#            JDKVersion: '1.11'
          Idea2020:
            IDEA_VERSION: 'IC-2020.1.2'
            JDKVersion: '1.11'
            imageName: 'ubuntu-latest'
#          IdeaEAP:
#            IDEA_VERSION: 'LATEST-EAP-SNAPSHOT'
#            JDKVersion: '1.11'
      pool: julienh
      steps:
      - checkout: self
        fetchDepth: 1
      - template: update-gradle-version-steps.yml
      - task: DownloadSecureFile@1
        displayName: 'Download Maven settings'
        name: mavenSettings
        inputs:
          secureFile: 'maven-settings.xml'
      - bash: |
          mvn org.apache.maven.plugins:maven-dependency-plugin:3.1.1:unpack -B --settings "$(mavenSettings.secureFilePath)" -Denable-repo=qa -Dartifact=org.sonarsource.sonarlint.intellij:sonarlint-intellij:$(PROJECT_VERSION):zip "-DoutputDirectory=$(Agent.BuildDirectory)/staged-plugin"
        displayName: 'Download staged plugin'
        env:
          ARTIFACTORY_QA_READER_USERNAME: $(ARTIFACTORY_QA_READER_USERNAME)
          ARTIFACTORY_QA_READER_PASSWORD: $(ARTIFACTORY_QA_READER_PASSWORD)
      - bash: |
          set -e -o pipefail -u
          command -v nc || {
              sudo apt-get update && sudo apt-get install -y netcat
          }
          command -v xauth || {
            sudo apt-get update && sudo apt-get install -y xauth
          }
          command -v xvfb-run || {
              sudo apt-get update && sudo apt-get install -y xvfb
          }
          dir="~/.java/.userPrefs/jetbrains/_!(!!cg\"p!(}!}@\"j!(k!|w\"w!'8!b!\"p!':!e@=="
          mkdir -p "$dir"
          echo '<?xml version="1.0" encoding="UTF-8" standalone="no"?>
          <!DOCTYPE map SYSTEM "http://java.sun.com/dtd/preferences.dtd">
          <map MAP_XML_VERSION="1.0">
            <entry key="accepted_version" value="2.1"/>
            <entry key="eua_accepted_version" value="1.1"/>
            <entry key="privacyeap_accepted_version" value="2.1"/>
          </map>' > "$dir/prefs.xml"
          cd its
          source utils.sh
          log=~/gradlew-runIdeForUiTests.log
          xvfb-run --auto-servernum ./gradlew --stacktrace --info -PijVersion=$(IDEA_VERSION) "-PslPluginLocation=$(Agent.BuildDirectory)/staged-plugin/sonarlint-intellij" runIdeForUiTests >$log 2>&1 &
          # $! expands to the PID of the last process executed in the background
          ide_pid=$!

          # The test will gracefully close the IDE instance if successful,
          # but we still need to kill the IDE instance in case that test was not successful AND the IDE is still running.
          function finish {
            if ps -p $ide_pid >/dev/null 2>&1; then
              kill $ide_pid
            fi
          }
          trap finish EXIT

          last_line=0
          # Let's wait until Remote Robot plugin living within the IDE starts listening.
          info 'Logs of gradle runIdeForUiTests'
          while ! nc -z localhost 8080; do
            sleep 0.5
            tail -n+$((last_line+1)) $log
            last_line=$(wc -l < $log)
          done

          info 'Logs of gradle test'
          ./gradlew --info -PijVersion=$(IDEA_VERSION) test || {
            info 'Logs of IDE under test'
            cat /build/idea-sandbox/system/log/idea.log
            die 'UI tests failed; inspect Gradle and IDE logs above'
          }
        displayName: 'Run UI tests on $(IDEA_VERSION)'
      - bash: |
          set -e
          cd its
          cat build/idea-sandbox/system/log/idea.log
        displayName: 'Log'
        condition: succeededOrFailed()
